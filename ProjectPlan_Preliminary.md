# 撲克類遊戲後台分析與 AI 對弈系統 - 初步規劃書

**版本:** 0.1
**日期:** 2024-08-01

## 1. 簡介

### 1.1. 背景
本專案旨在為一個獨立的撲克類遊戲（支援德州撲克、梭哈、百家樂等，基於 Three.js + Next.js 前端，Golang 後端，MySQL 資料庫）開發一個後台分析與 AI 對弈系統。此後台系統將獨立於遊戲專案運行，專注於玩家行為分析、AI 輔助判斷、AI 對弈及綜合後台管理。

### 1.2. 核心目標
- **玩家行為分析**: 提供深入的玩家數據洞察（下注、勝率、頻率、時段），支援異常檢測與玩家分類。
- **AI 判斷玩家行為**: 利用機器學習模型（如 Isolation Forest, K-Means）高效識別異常模式與玩家群體。
- **AI 與玩家對弈**: 開發 AI 模組參與遊戲，動態調整策略以優化莊家（或 AI 代理）的長期勝率。
- **後台管理**: 提供全面的管理介面，涵蓋玩家數據查詢、AI 模型配置、對弈策略調整、報表生成與權限控制。
- **數據整合**: 與遊戲專案的 MySQL 資料庫無縫銜接，讀取遊戲日誌，儲存分析與對弈結果。
- **系統分離**: 維持後台系統的獨立性，透過 API 或 WebSocket 與遊戲專案交互。

### 1.3. 範圍摘要
此系統將包含數據提取、行為分析模型、對弈 AI 模型、後端服務接口、前端管理介面以及必要的數據儲存。

## 2. 功能需求

### 2.1. 玩家行為分析
- **核心指標**:
    - 下注行為：總額、均額、次數、遊戲偏好。
    - 勝率與盈虧：各遊戲勝率、淨盈虧。
    - 參與頻率：次數、活躍天數、平均時長。
    - 時間分佈：活躍時段分析（熱力圖）。
- **異常檢測**: 識別潛在作弊、刷返水行為（如高頻小額下注、異常高勝率、連續贏局）。
- **玩家分類**: 基於行為模式將玩家分為不同類型（如：休閒、VIP、高風險）。

### 2.2. AI 判斷玩家行為
- **異常檢測**: 使用 Isolation Forest 等模型自動標記異常行為。
- **玩家分類**: 使用 K-Means 等分群算法自動歸類玩家。
- **效能優化**: 以 AI 推理部分取代複雜 SQL 查詢，降低資料庫負載。

### 2.3. AI 與玩家對弈
- **德州撲克/梭哈**:
    - 角色：莊家或虛擬玩家。
    - 技術：強化學習（MCTS / DQN）。
    - 策略：根據牌局狀態、玩家歷史行為（激進/保守）動態調整決策（加注、跟注、棄牌）。
- **百家樂**:
    - 角色：模擬莊家或提供決策建議。
    - 技術：統計模型（如馬爾可夫鏈分析趨勢）、基於歷史數據的策略調整。
    - 策略：分析玩家下注偏好（押莊/閒），調整內部模擬策略或風險參數。
- **莊家勝率提升**:
    - 動態調整：依據玩家分類調整 AI 風險偏好。
    - 風險控制：設定單局最大損失限制。

### 2.4. 後台管理
- **玩家數據管理**: 查詢基本資訊、遊戲記錄、行為快照；手動標記/調整分類。
- **AI 模型管理**: 配置模型參數（如 Isolation Forest 的 contamination、K-Means 的 k 值）；監控性能指標。
- **對弈策略管理**: 調整 AI 對弈參數（如 MCTS 探索率）；設定風險規則；查看對弈歷史與成效。
- **報表生成**: 提供行為分析、對弈結果、管理操作的報表；支援篩選與 CSV 匯出。
- **權限控制**: 基於角色的訪問控制（管理員、分析師、運營）；用戶登錄與操作日誌記錄。

### 2.5. 報表與視覺化
- **報表內容**: 行為分析摘要、異常玩家列表、AI 對弈勝率/盈虧、管理日誌等。
- **視覺化**: 使用 Chart.js 實現柱狀圖、散點圖、熱力圖等。
- **匯出**: 提供 CSV 格式下載。

## 3. 技術架構

### 3.1. 技術棧
- **後端**: Golang (Gin, GORM)
- **AI 服務**: Python (FastAPI, scikit-learn, PyTorch/TensorFlow)
- **資料庫**: MySQL (主數據儲存), Redis (快取)
- **前端**: Next.js (React), Chart.js
- **部署**: Docker, Kubernetes
- **身份驗證**: JWT

### 3.2. 架構圖
```
[遊戲專案: Three.js + Next.js]  <--(REST API / WebSocket)--> [後台服務: Golang + Gin]
                                                                    | (GORM)      | (REST API)
                                                                 [MySQL]       [AI 服務: Python + FastAPI]
                                                                    | (Redis Client)
                                                                 [Redis]
                                                                    ^
                                                                    | (API)
                                                          [後台管理介面: Next.js + Chart.js]
```

### 3.3. 組件交互
- **遊戲專案**: 發送遊戲日誌 (REST/WS), 請求 AI 對弈行動 (REST/WS)。
- **後台服務 (Go)**: 處理 API 請求, 調度特徵提取, 調用 AI 服務, 讀寫 MySQL/Redis, 處理後台管理邏輯。
- **AI 服務 (Python)**: 執行模型訓練 (離線) 和推理 (線上), 提供行為分析和對弈決策 API。
- **前端 (Next.js)**: 調用後台 API, 展示數據、報表和管理介面。

## 4. 資料管理

### 4.1. 資料庫設計 (MySQL)
- **共用表格 (與遊戲專案)**:
    - `players`: 玩家基本資訊。
    - `game_logs`: 原始遊戲行為記錄。
    - `point_transactions`: 點數/資金變動記錄 (用於精確計算盈虧)。
- **後台獨立表格**:
    - `player_behavior_snapshots`: 定期生成的玩家行為快照。
    - `ai_anomaly_predictions`: AI 異常檢測結果。
    - `ai_game_results`: AI 對弈記錄與結果。
    - `admin_users`: 後台管理員帳號與角色。
    - `admin_logs`: 後台操作日誌。
- **索引**: 關鍵查詢欄位（如 `player_id`, `game_type`, `created_at`, `period_start`）需建立索引。
- **數據一致性**: 需明確 `net_profit` 的計算邏輯，建議基於 `point_transactions`。

### 4.2. 快取 (Redis)
- 儲存熱點數據，如近期玩家特徵、AI 對弈中間狀態，減少 DB 查詢壓力。

## 5. AI/ML 設計

### 5.1. 行為分析模型
- **異常檢測**: Isolation Forest (無監督)。
    - 特徵: 總/均下注額、頻率、勝率、連勝/連敗、活躍時段等。
- **玩家分類**: K-Means (無監督)。
    - 特徵: 總下注、活躍度、平均時長、淨盈虧等。

### 5.2. AI 對弈模型
- **德州撲克/梭哈**: MCTS 結合 DQN (強化學習)。
    - 輸入: 牌局狀態、歷史行動、玩家行為特徵。
    - 輸出: 最佳行動。
    - 挑戰: 模型複雜度高，訓練和調優需要較多時間和計算資源。
- **百家樂**: 統計模型 / 馬爾可夫鏈 (分析趨勢) + 規則/啟發式策略。
    - 輸入: 歷史牌局結果、玩家下注模式。
    - 輸出: 調整內部模擬策略或風險參數 (需明確 AI 介入點)。

### 5.3. 訓練與推理
- **訓練**: 離線進行，使用歷史 `game_logs` 和 `point_transactions`。
- **推理**: 線上提供服務，透過 FastAPI 部署。模型檔案 (.pkl, .pt) 需妥善管理。

## 6. 系統設計

### 6.1. 後端 (Golang)
- **核心模組**: 特徵提取、AI 服務調用、對弈邏輯協調、後台 CRUD 操作、API 接口、定時任務 (如生成快照)。
- **API 設計**: 提供 RESTful API 供前端和遊戲專案調用。
- **錯誤處理與日誌**: 完善的錯誤處理機制和詳細的日誌記錄。

### 6.2. 前端 (Next.js)
- **頁面結構**: 儀表板、玩家管理、行為分析報表、AI 模型管理、對弈管理、用戶權限管理、操作日誌。
- **組件化**: 可複用的 UI 組件。
- **狀態管理**: 管理前端應用狀態。
- **API 交互**: 與後端 API 安全可靠地通信。

## 7. 整合策略

### 7.1. 與遊戲專案交互
- **主要方式**: REST API。
- **可選方式**: WebSocket (用於需要低延遲的實時場景，如 AI 對弈)。
- **數據契約**: 使用 Swagger/OpenAPI 明確定義 API 接口格式。
- **數據同步**: 確保遊戲日誌能及時、準確地傳輸到後台系統。

### 7.2. 資料庫共用
- 透過 GORM 等 ORM 訪問共用表格。
- 注意權限控制和遷移管理。

## 8. 開發計劃 (初步估計)

**總體估計**: 原計劃 26 天較為緊張，特別是 AI 模型訓練/調優和系統整合測試。建議採用分階段方法或預留更充裕時間。

| **階段**             | **主要任務**                                                                 | **預估時間 (修正建議)** | **關鍵產出**                                       |
| -------------------- | ---------------------------------------------------------------------------- | ---------------------- | -------------------------------------------------- |
| **1. 基礎設施與設計** | 環境搭建、資料庫設計與初始化、詳細 API 設計、技術選型確認                  | 3-4 天                 | 環境、空數據庫、API 文檔初稿                       |
| **2. 核心後端與特徵** | Golang 後端框架、玩家/日誌數據接入、特徵提取邏輯、Redis 整合                | 4-5 天                 | 基礎後端服務、特徵提取 API                         |
| **3. AI 行為分析**    | Python AI 服務框架、Isolation Forest & K-Means 實現與初步訓練、API 部署       | 5-7 天                 | 行為分析 API、初步模型                             |
| **4. 後台管理基礎**   | 後端管理 API (CRUD)、JWT 權限控制、前端管理介面框架、基礎數據展示         | 5-6 天                 | 後台管理 API、可登錄的前端框架、玩家列表展示         |
| **5. AI 對弈模型**    | MCTS/DQN (撲克) & 統計模型 (百家樂) 實現與模擬訓練、對弈 API 部署           | 7-10+ 天               | 對弈 API、初步對弈模型 (可能需要持續迭代)          |
| **6. 前後端整合與報表** | 前端集成行為分析/對弈結果、報表與視覺化開發 (Chart.js)、管理功能完善         | 5-7 天                 | 功能完整的後台介面、報表                           |
| **7. 整合測試與優化** | 端到端測試、性能測試 (API 延遲、DB 負載、AI 響應)、根據測試結果進行優化 | 4-6 天                 | 測試報告、優化後的系統                             |
| **8. 部署與監控**    | Docker 化、Kubernetes 部署配置、設置監控 (Prometheus/Grafana)              | 3-4 天                 | 可運行的生產環境、監控儀表板                       |
| **總計 (修正後)**    |                                                                              | **~40 - 50+ 天**        |                                                    |

**建議**: 考慮分期交付。第一期可專注於行為分析和後台管理基礎，第二期再深入 AI 對弈。

## 9. 風險管理

| **風險**                         | **可能性** | **影響** | **緩解措施**                                                                 |
| -------------------------------- | -------- | -------- | ---------------------------------------------------------------------------- |
| 1. AI 對弈效果不達預期 (勝率低)    | 中       | 高       | 增加訓練數據/模擬、調整模型結構/參數、引入專家知識、接受迭代優化。               |
| 2. MySQL 性能瓶頸              | 中       | 中       | 索引優化、查詢優化、讀寫分離、分庫分表、加強 Redis 快取利用。                    |
| 3. AI 服務延遲過高 (影響實時對弈) | 中       | 高       | 模型輕量化、推理優化 (ONNX/TensorRT)、服務水平擴展 (Kubernetes)、異步處理。     |
| 4. 數據質量/一致性問題           | 低       | 高       | 與遊戲專案明確數據契約、增加數據清洗與驗證層、監控數據異常。                   |
| 5. 後台管理權限漏洞              | 低       | 高       | 嚴格的代碼審查、滲透測試、最小權限原則、詳細的操作日誌審計。                   |
| 6. 開發時間超出預期              | 高       | 中       | 分階段開發、優先級排序、加強溝通、使用敏捷開發方法、預留緩衝時間。               |

## 10. 性能與擴展性

- **計算優化**: 利用 AI 模型減少複雜 DB 查詢，快照機制避免重複計算。
- **資料庫優化**: 索引、分表、批量操作、快取。
- **服務擴展**: 無狀態後端服務和 AI 服務易於透過 Kubernetes 進行水平擴展。
- **監控**: 使用 Prometheus + Grafana 監控關鍵指標 (API 延遲、QPS、錯誤率、資源使用率、AI 模型性能)。

## 11. 附錄 (待補充)

- 詳細 API 規格 (Swagger/OpenAPI)
- 詳細資料庫 Schema
- AI 模型評估指標定義 