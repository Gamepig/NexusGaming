# 德州撲克開發任務：發牌邏輯 (Task 3.2)

**目標**：實現德州撲克各個階段的發牌規則，包括底牌、公共牌和燒牌。

---

## 3.2.1：發底牌 (Hole Cards) (Backend: Go)

### 3.2.1.1：確定發牌順序
-   **3.2.1.1.1-L6**: 在 `Table.DealHoleCards()` 方法中實現。
-   **3.2.1.1.2-L6**: 從小盲注玩家 (SB) 左手邊的玩家開始，按順時針順序發牌。
-   **3.2.1.1.3-L6**: 獲取活躍玩家列表 (狀態為 "active" 或等待加入遊戲的玩家)。
-   **3.2.1.1.4-L6**: 處理 Button/SB/BB 位置確定後的起始玩家。

### 3.2.1.2：執行發牌
-   **3.2.1.2.1-L6**: 循環兩次 (每位玩家發兩張牌)。
-   **3.2.1.2.2-L6**: 在每次循環中，遍歷活躍玩家 (按發牌順序)。
-   **3.2.1.2.3-L6**: 為每個活躍玩家調用 `Deck.DrawCard()` 獲取一張牌。
-   **3.2.1.2.4-L6**: 將抽到的牌加入玩家的 `Hand []*Card`。
-   **3.2.1.2.5-L6**: 檢查 `DrawCard` 是否返回錯誤 (牌堆耗盡，正常情況下不應在發底牌時發生)。

### 3.2.1.3：更新狀態與通知
-   **3.2.1.3.1-L6**: 發牌完成後，更新 `Table` 的遊戲階段狀態 (例如 `GameStatePreFlop`)。
-   **3.2.1.3.2-L6**: **私密地** 將底牌信息通過 WebSocket 發送給每個對應的玩家。
    -   消息結構: `{"event": "hole_cards", "data": {"cards": [{"id": "SA"}, {"id": "S2"}]}}`
-   **3.2.1.3.3-L6**: 向所有玩家廣播發牌完成事件，但不包含具體牌面 (用於觸發前端動畫或狀態更新)。
    -   消息結構: `{"event": "dealing_complete", "data": {"round": "Pre-Flop"}}`
-   **3.2.1.3.4-L6**: 更新牌堆的 `currentIndex`。
-   **3.2.1.3.5-L6**: (前端任務) 實現接收底牌並顯示給玩家本人。
-   **3.2.1.3.6-L6**: (前端任務) 實現發牌動畫，顯示牌背給其他玩家。

---

## 3.2.2：發公共牌 (Community Cards) (Backend: Go)

### 3.2.2.1：發翻牌 (Flop)
-   **3.2.2.1.1-L6**: 在 `Table.DealFlop()` 方法中實現 (在 Pre-Flop 輪下注結束後調用)。
-   **3.2.2.1.2-L6**: 調用 `Deck.DrawCard()` 燒掉一張牌 (見 3.2.3)。
-   **3.2.2.1.3-L6**: 連續調用 `Deck.DrawCard()` 三次，獲取三張翻牌。
-   **3.2.2.1.4-L6**: 將三張翻牌存儲到 `Table` struct 中的 `CommunityCards []*Card`。
-   **3.2.2.1.5-L6**: 更新遊戲階段狀態 (例如 `GameStateFlop`)。
-   **3.2.2.1.6-L6**: **公開地** 將翻牌信息通過 WebSocket 廣播給所有玩家。
    -   消息結構: `{"event": "community_cards", "data": {"round": "Flop", "cards": [{"id": "H5"}, {"id": "D8"}, {"id": "CK"}]}}`
-   **3.2.2.1.7-L6**: (前端任務) 實現接收翻牌信息並顯示在公共區域。
-   **3.2.2.1.8-L6**: (前端任務) 實現翻牌動畫 (先燒牌動畫，再發三張牌)。

### 3.2.2.2：發轉牌 (Turn)
-   **3.2.2.2.1-L6**: 在 `Table.DealTurn()` 方法中實現 (在 Flop 輪下注結束後調用)。
-   **3.2.2.2.2-L6**: 調用 `Deck.DrawCard()` 燒掉一張牌。
-   **3.2.2.2.3-L6**: 調用 `Deck.DrawCard()` 一次，獲取轉牌。
-   **3.2.2.2.4-L6**: 將轉牌追加到 `Table.CommunityCards`。
-   **3.2.2.2.5-L6**: 更新遊戲階段狀態 (例如 `GameStateTurn`)。
-   **3.2.2.2.6-L6**: **公開地** 將轉牌信息通過 WebSocket 廣播給所有玩家。
    -   消息結構: `{"event": "community_cards", "data": {"round": "Turn", "cards": [{"id": "S7"}]}}` (只發送新增的牌) 或發送完整公共牌列表。
-   **3.2.2.2.7-L6**: (前端任務) 實現接收轉牌信息並追加顯示。
-   **3.2.2.2.8-L6**: (前端任務) 實現轉牌動畫。

### 3.2.2.3：發河牌 (River)
-   **3.2.2.3.1-L6**: 在 `Table.DealRiver()` 方法中實現 (在 Turn 輪下注結束後調用)。
-   **3.2.2.3.2-L6**: 調用 `Deck.DrawCard()` 燒掉一張牌。
-   **3.2.2.3.3-L6**: 調用 `Deck.DrawCard()` 一次，獲取河牌。
-   **3.2.2.3.4-L6**: 將河牌追加到 `Table.CommunityCards`。
-   **3.2.2.3.5-L6**: 更新遊戲階段狀態 (例如 `GameStateRiver`)。
-   **3.2.2.3.6-L6**: **公開地** 將河牌信息通過 WebSocket 廣播給所有玩家。
    -   消息結構: `{"event": "community_cards", "data": {"round": "River", "cards": [{"id": "HA"}]}}` (只發送新增的牌) 或發送完整公共牌列表。
-   **3.2.2.3.7-L6**: (前端任務) 實現接收河牌信息並追加顯示。
-   **3.2.2.3.8-L6**: (前端任務) 實現河牌動畫。

---

## 3.2.3：處理燒牌 (Burnt Cards) (Backend: Go)

### 3.2.3.1：實現燒牌邏輯
-   **3.2.3.1.1-L6**: 在 `Table` struct 中添加 `BurntCards []*Card` (用於記錄，非必需邏輯)。
-   **3.2.3.1.2-L6**: 在 `DealFlop`, `DealTurn`, `DealRiver` 方法的開頭，調用 `Deck.DrawCard()` 來執行燒牌。
-   **3.2.3.1.3-L6**: (可選) 將燒掉的牌添加到 `BurntCards` 列表。
-   **3.2.3.1.4-L6**: 確保燒牌操作正確更新 `Deck.currentIndex`。

### 3.2.3.2：前端提示 (可選)
-   **3.2.3.2.1-L6**: 可以定義一個 WebSocket 消息通知前端執行了燒牌動作 (不顯示牌面)，用於觸發燒牌動畫。
    -   消息結構: `{"event": "burn_card", "data": {"round": "Flop"}}`
-   **3.2.3.2.2-L6**: (前端任務) 實現燒牌動畫效果 (例如將一張牌背移到旁邊)。

--- 