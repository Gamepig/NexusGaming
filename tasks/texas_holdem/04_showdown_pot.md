# 德州撲克開發任務：攤牌與底池分配 (Task 3.4)

**目標**：實現河牌圈下注結束後的攤牌邏輯，比較玩家手牌，確定各底池（主池和邊池）的獲勝者，並分配籌碼。

---

## 3.4.1：觸發攤牌 (Showdown) (Backend: Go)

### 3.4.1.1：攤牌觸發條件
-   **3.4.1.1.1-L6**: 在河牌圈 (River) 的 `Table.EndBettingRound()` 方法中判斷。
-   **3.4.1.1.2-L6**: 條件：有兩個或以上玩家狀態為 "active" 或 "all-in" (即未蓋牌)。
-   **3.4.1.1.3-L6**: 如果觸發，調用 `Table.StartShowdown()` 方法。
-   **3.4.1.1.4-L6**: 如果只有一個玩家未蓋牌，則該玩家直接贏得所有底池 (無需比牌)，跳過大部分攤牌邏輯，直接進入分配階段 (見 3.4.3，但需要簡化)。

### 3.4.1.2：確定攤牌順序
-   **3.4.1.2.1-L6**: 在 `Table.StartShowdown()` 中實現。
-   **3.4.1.2.2-L6**: 通常順序是：最後一個在河牌圈下注或加注的玩家先攤牌 (`LastRaiserSeatIndex`)。
-   **3.4.1.2.3-L6**: 如果河牌圈無人下注/加注 (所有人過牌)，則從 Button 左手邊第一個未蓋牌的玩家開始，按順時針順序攤牌。
-   **3.4.1.2.4-L6**: 獲取所有需要攤牌的玩家列表 (狀態為 "active" 或 "all-in")。
-   **3.4.1.2.5-L6**: 記錄攤牌順序。

### 3.4.1.3：通知前端攤牌開始
-   **3.4.1.3.1-L6**: 廣播攤牌開始事件，包含需要攤牌的玩家座位索引列表和攤牌順序。
    -   `{"event": "showdown_start", "data": {"showdown_players": [seat1, seat2, ...], "showdown_order": [seat_order1, seat_order2, ...]}}`
-   **3.4.1.3.2-L6**: (前端任務) 接收通知，準備顯示玩家手牌和牌型。

---

## 3.4.2：手牌評估與比較 (Backend: Go, Common Poker Logic)

(建議將牌型評估邏輯放到通用的 `pkg/pokerlogic` 或類似包中)

### 3.4.2.1：獲取玩家最佳手牌
-   **3.4.2.1.1-L6**: 為每個參與攤牌的玩家 (狀態 "active" 或 "all-in") 執行。
-   **3.4.2.1.2-L6**: 組合玩家的 2 張底牌 (`Player.Hand`) 和 5 張公共牌 (`Table.CommunityCards`)，共 7 張牌。
-   **3.4.2.1.3-L6**: **實現核心牌型評估函數** `EvaluateHand(cards []*card.Card) HandResult`。
    -   輸入：7 張牌。
    -   輸出：`HandResult` struct，包含:
        -   `HandRank HandRankEnum` (牌型等級，例如 RoyalFlush, StraightFlush, ..., HighCard)
        -   `BestFiveCards []*card.Card` (組成最佳牌型的 5 張牌)
        -   `Kickers []*card.Card` (用於比較相同牌型的 Ticker 牌，按重要性排序)
-   **3.4.2.1.4-L7**: 實現牌型判斷邏輯 (可以借鑒開源庫或自行實現)：
    -   **檢查同花順/皇家同花順**: 遍歷所有 5 張牌組合，檢查是否同時滿足同花和順子條件。
    -   **檢查四條**: 統計各 Rank 出現次數，檢查是否有 Rank 出現 4 次。
    -   **檢查葫蘆**: 統計 Rank 出現次數，檢查是否有一個 Rank 出現 3 次且另一個 Rank 出現 2 次。
    -   **檢查同花**: 統計各 Suit 出現次數，檢查是否有 Suit 出現 >= 5 次，並找出其中最大的 5 張。
    -   **檢查順子**: 將 7 張牌按 Rank 排序 (注意 A 可以是 A2345 或 TJQKA)，檢查是否有連續 5 張。處理 A 的特殊情況。
    -   **檢查三條**: 統計 Rank 出現次數，檢查是否有 Rank 出現 3 次 (且非葫蘆)。
    -   **檢查兩對**: 統計 Rank 出現次數，檢查是否有兩個 Rank 出現 2 次。
    -   **檢查一對**: 統計 Rank 出現次數，檢查是否有一個 Rank 出現 2 次 (且非兩對、三條等)。
    -   **高牌**: 如果以上都不是，則取最大的 5 張牌。
-   **3.4.2.1.5-L6**: 將每個玩家的 `HandResult` 存儲起來 (例如在 `Table` 的臨時 map 中 `map[int]HandResult`)。

### 3.4.2.2：比較玩家手牌
-   **3.4.2.2.1-L6**: **實現核心牌型比較函數** `CompareHandResults(result1 HandResult, result2 HandResult) int`。
    -   輸入：兩個玩家的 `HandResult`。
    -   輸出：1 (result1 贏), -1 (result2 贏), 0 (平局)。
-   **3.4.2.2.2-L7**: 比較邏輯：
    -   首先比較 `HandRank`。不同則直接得出結果。
    -   如果 `HandRank` 相同，則根據牌型比較關鍵牌 (例如比較四條的 Rank，比較葫蘆中三條的 Rank，比較順子/同花的最高牌 Rank)。
    -   如果關鍵牌相同，則比較 `Kickers` (按順序比較，從最重要的 Kicker 開始)。
    -   如果所有 Kicker 都相同，則為平局。
-   **3.4.2.2.3-L6**: (單元測試) 編寫大量測試用例覆蓋各種牌型及其比較規則，特別是 Kicker 比較和 A 的順子情況。

### 3.4.2.3：確定獲勝者 (針對每個底池)
-   **3.4.2.3.1-L6**: 對於每個底池 (主池和所有邊池 `Pot.SidePots`) 分別執行。
-   **3.4.2.3.2-L6**: 獲取該底池的合格玩家列表 (`EligiblePlayerIDs` 或對應的座位索引)。
-   **3.4.2.3.3-L6**: 在合格玩家中，使用 `CompareHandResults` 找出最佳手牌的玩家 (可能有多個平局玩家)。
-   **3.4.2.3.4-L6**: 記錄每個底池的獲勝者列表 (座位索引)。
-   **3.4.2.3.5-L6**: 將評估結果存儲，例如 `map[string][]int{"main_pot": [winnerSeat1, winnerSeat2], "side_pot_0": [winnerSeat1]}`。

### 3.4.2.4：通知前端手牌評估結果
-   **3.4.2.4.1-L6**: 在評估和比較完成後，廣播每個參與攤牌玩家的手牌和牌型信息。
    -   `{"event": "player_hand_reveal", "data": {"seat_index": ..., "cards": [...], "hand_rank": "TwoPair", "best_five": [...]}}`
-   **3.4.2.4.2-L6**: (前端任務) 接收通知，按攤牌順序依次或同時顯示玩家底牌、最佳 5 張牌和牌型名稱。

---

## 3.4.3：分配底池 (Pot Distribution) (Backend: Go)

### 3.4.3.1：按順序處理底池
-   **3.4.3.1.1-L6**: 在 `Table.DistributePots()` 方法中實現。
-   **3.4.3.1.2-L6**: 建議從邊池 (Side Pots) 開始處理，最後處理主池 (Main Pot)。邊池通常是按創建順序（或 All-in 金額從小到大）處理。

### 3.4.3.2：分配單個底池
-   **3.4.3.2.1-L6**: 對於當前處理的底池 (主池或某個邊池)：
    -   獲取該底池的金額 (`potAmount`)。
    -   獲取該底池的獲勝者列表 (`winners = []int{winnerSeat1, winnerSeat2, ...}`)。
-   **3.4.3.2.2-L6**: 計算每個獲勝者應得的份額 `share = potAmount / len(winners)`。 (注意整除問題，零頭如何處理？常規做法是給予順序靠前的玩家，或隨機分配，或留在底池給下一局 - 選擇一種策略並實現)。
-   **3.4.3.2.3-L6**: 處理分配零頭的邏輯 (例如，將 `potAmount % len(winners)` 的籌碼分配給第一個獲勝者)。
-   **3.4.3.2.4-L6**: 遍歷獲勝者列表，為每個獲勝者 `Player.AddChips(share)` (或加上零頭)。
-   **3.4.3.2.5-L6**: 記錄每個玩家贏得的金額 (用於通知)。

### 3.4.3.3：處理特殊情況 (只有一個贏家)
-   **3.4.3.3.1-L6**: 如果某個底池只有一個獲勝者 (`len(winners) == 1`)，則該玩家贏得全部 `potAmount`。
-   **3.4.3.3.2-L6**: 如果遊戲在攤牌前結束 (只有一個未蓋牌玩家)，該玩家贏得所有底池的全部金額。

### 3.4.3.4：更新狀態與通知
-   **3.4.3.4.1-L6**: 廣播底池分配結果通知。
    -   消息應包含每個底池的獲勝者、分配金額，以及玩家籌碼的最終更新。
    -   `{"event": "pot_distributed", "data": {"pot_results": [{"pot_type": "main", "amount": ..., "winners": [{"seat_index": ..., "amount_won": ...}, ...]}, {"pot_type": "side_0", ...}], "player_chips": [{"seat_index": ..., "final_chips": ...}, ...]}}`
-   **3.4.3.4.2-L6**: 更新所有相關玩家的 `Player.Chips`。
-   **3.4.3.4.3-L6**: 清空 `Pot.MainPotAmount` 和 `Pot.SidePots`。
-   **3.4.3.4.4-L6**: 標記本局遊戲正式結束 (`Table.EndHand()`)。
-   **3.4.3.4.5-L6**: (前端任務) 接收通知，顯示獲勝者，播放籌碼分配動畫，更新玩家籌碼顯示。

---

## 3.4.4：手機端顯示優化 (初步接口定義)

### 3.4.4.1：清晰顯示牌型和獲勝者
-   **3.4.4.1.1-L6**: 後端通知應包含清晰的牌型名稱 (`HandRank` 的字符串表示)。
-   **3.4.4.1.2-L6**: 後端通知應明確標示每個底池的獲勝者座位索引。
-   **3.4.4.1.3-L6**: (前端任務) 在手機上清晰高亮獲勝玩家、其手牌、最佳牌型組合以及贏得的籌碼金額。

### 3.4.4.2：動畫效果
-   **3.4.4.2.1-L6**: (前端任務) 實現流暢的攤牌動畫（逐個或同時翻開底牌）。
-   **3.4.4.2.2-L6**: (前端任務) 實現籌碼從底池移動到獲勝玩家的動畫。

### 3.4.4.3：佈局調整
-   **3.4.4.3.1-L6**: (前端任務) 確保攤牌信息（牌面、牌型、金額）在小屏幕上不會擁擠或重疊。可能需要臨時放大顯示區域或分步顯示信息。

--- 