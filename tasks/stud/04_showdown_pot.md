# 七張梭哈開發任務：攤牌與底池分配 (Task 4.4)

**目標**：實現七張梭哈在第七街下注結束後的攤牌邏輯，使用玩家的 7 張牌評估最佳 5 張牌手牌，比較大小，並分配底池。

---

## 4.4.1：觸發攤牌 (Showdown) (Backend: Go)

### 4.4.1.1：攤牌觸發條件
-   **4.4.1.1.1-L6**: 在第七街 (Seventh Street) 的 `Table.EndStudBettingRound()` 方法中判斷。
-   **4.4.1.1.2-L6**: 條件：有兩個或以上玩家狀態為 "active" 或 "all-in" (未蓋牌)。
-   **4.4.1.1.3-L6**: 如果觸發，調用 `Table.StartStudShowdown()` 方法。
-   **4.4.1.1.4-L6**: 如果只有一個玩家未蓋牌，該玩家直接贏得所有底池。

### 4.4.1.2：確定攤牌順序
-   **4.4.1.2.1-L6**: 在 `Table.StartStudShowdown()` 中實現。
-   **4.4.1.2.2-L6**: 梭哈的攤牌順序通常是：最後一個在第七街下注或加注的玩家先攤牌 (`LastBettorOrRaiserSeatIndex`)。
-   **4.4.1.2.3-L6**: 如果第七街無人下注/加注，則從 Bring-in 玩家**之後**第一個未蓋牌的玩家開始，按順時針順序攤牌。
-   **4.4.1.2.4-L6**: 獲取所有需要攤牌的玩家列表 (狀態 "active" 或 "all-in")。
-   **4.4.1.2.5-L6**: 記錄攤牌順序。

### 4.4.1.3：通知前端攤牌開始
-   **4.4.1.3.1-L6**: 廣播攤牌開始事件，包含攤牌玩家和順序 (同 Hold'em)。
    -   `{"event": "showdown_start", "data": {"showdown_players": [...], "showdown_order": [...]}}`
-   **4.4.1.3.2-L6**: (Frontend) 準備顯示所有牌面。

---

## 4.4.2：手牌評估與比較 (Backend: Go, Common Poker Logic)

### 4.4.2.1：獲取玩家最佳手牌
-   **4.4.2.1.1-L6**: 為每個參與攤牌的玩家執行。
-   **4.4.2.1.2-L6**: 獲取玩家的全部 7 張手牌 (`Player.Hand`)。
    -   注意：如果第七街使用了公共牌，則玩家實際只有 6 張私有牌 + 1 張公共牌。評估函數需要能處理這種情況，將公共牌加入考慮。
-   **4.4.2.1.3-L6**: **重用或調用 Hold'em 的核心牌型評估函數** `EvaluateHand(cards []*card.Card) HandResult`。
    -   輸入：玩家的 7 張牌 (或 6+1)。
    -   輸出：`HandResult` (包含 `HandRank`, `BestFiveCards`, `Kickers`)。
-   **4.4.2.1.4-L6**: 將每個玩家的 `HandResult` 存儲起來。

### 4.4.2.2：比較玩家手牌
-   **4.4.2.2.1-L6**: **重用 Hold'em 的核心牌型比較函數** `CompareHandResults(result1 HandResult, result2 HandResult) int`。
    -   梭哈的牌型等級和比較規則與 Hold'em 完全相同 (都是從 7 張牌選最佳 5 張比較)。
-   **4.4.2.2.2-L6**: (單元測試) 確保比較函數的測試覆蓋了梭哈可能出現的牌面組合。

### 4.4.2.3：確定獲勝者 (針對每個底池)
-   **4.4.2.3.1-L6**: 對於每個底池 (主池和所有邊池) 分別執行。
-   **4.4.2.3.2-L6**: 獲取該底池的合格玩家列表。
-   **4.4.2.3.3-L6**: 在合格玩家中，使用 `CompareHandResults` 找出最佳手牌的玩家 (可能平局)。
-   **4.4.2.3.4-L6**: 記錄每個底池的獲勝者列表。
-   **4.4.2.3.5-L6**: 存儲評估結果。

### 4.4.2.4：通知前端手牌評估結果
-   **4.4.2.4.1-L6**: 廣播每個參與攤牌玩家的**全部 7 張牌** (或 6+1 公共牌) 和最終評估結果。
    -   `{"event": "player_hand_reveal_stud", "data": {"seat_index": ..., "all_cards": [...], "visible_cards": [...], "best_five": [...], "hand_rank": "Flush"}}`
    -   包含 `visible_cards` 有助於前端區分顯示。
-   **4.4.2.4.2-L6**: (Frontend) 按攤牌順序顯示玩家的暗牌、亮牌、最佳組合和牌型。

---

## 4.4.3：分配底池 (Pot Distribution) (Backend: Go)

### 4.4.3.1：按順序處理底池
-   **4.4.3.1.1-L6**: 重用 Hold'em 的 `Table.DistributePots()` 方法。
-   **4.4.3.1.2-L6**: 從邊池開始，最後處理主池。

### 4.4.3.2：分配單個底池
-   **4.4.3.2.1-L6**: 重用 Hold'em 的分配邏輯。
    -   獲取底池金額。
    -   獲取獲勝者列表。
    -   計算份額，處理平局和零頭。
    -   更新玩家籌碼 (`Player.AddChips`)。
    -   記錄贏得金額。

### 4.4.3.3：處理特殊情況
-   **4.4.3.3.1-L6**: 重用 Hold'em 的邏輯 (單一獲勝者贏得全部)。

### 4.4.3.4：更新狀態與通知
-   **4.4.3.4.1-L6**: 廣播底池分配結果通知 (結構同 Hold'em)。
    -   `{"event": "pot_distributed", "data": {"pot_results": [...], "player_chips": [...]}}`
-   **4.4.3.4.2-L6**: 更新玩家 `Player.Chips`。
-   **4.4.3.4.3-L6**: 清空底池。
-   **4.4.3.4.4-L6**: 標記牌局結束 `Table.EndHand()`。
-   **4.4.3.4.5-L6**: (Frontend) 顯示獲勝者、動畫、更新籌碼。

---

## 4.4.4：手機端顯示優化 (初步接口定義)

### 4.4.4.1：清晰顯示牌面和牌型
-   **4.4.4.1.1-L6**: (Frontend) 攤牌時需要清晰展示玩家的 2 張暗牌、4 張明牌和第 7 張暗牌 (或公共牌)。
-   **4.4.4.1.2-L6**: (Frontend) 高亮顯示組成最佳 5 張牌的牌面。
-   **4.4.4.1.3-L6**: (Frontend) 明顯標示獲勝者和贏得金額。

### 4.4.4.2：動畫效果
-   **4.4.4.2.1-L6**: (Frontend) 實現梭哈特有的攤牌動畫 (逐個翻開第 7 張暗牌，或直接顯示公共牌)。
-   **4.4.4.2.2-L6**: (Frontend) 重用籌碼分配動畫。

### 4.4.4.3：佈局調整
-   **4.4.4.3.1-L6**: (Frontend) 確保在小屏幕上能容納最多 7 張牌的顯示，可能需要臨時放大或特殊排列。

--- 