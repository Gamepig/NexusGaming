# 德州撲克遊戲邏輯詳細規劃

本文檔詳細記錄了德州撲克遊戲的核心邏輯設計，涵蓋初始化、發牌、下注、比牌、狀態管理和手機優化等方面，並包含各主要環節的流程圖。

---

## 任務 3.1：初始化遊戲
**目標**：設置遊戲開始前的環境，確保9人桌正確配置，支援手機端顯示與操作。

### 3.1.1：創建遊戲配置
- **3.1.1.1：定義盲注結構**
    - 3.1.1.1.1：設置小盲金額 (10)。
    - 3.1.1.1.2：設置大盲金額 (20)。
    - 3.1.1.1.3：創建配置文件 (JSON/物件) 儲存盲注。
    - 3.1.1.1.4：設計盲注遞增規則 (可選)。
    - 3.1.1.1.5：確保配置可擴展 (支援其他遊戲)。
- **3.1.1.2：設置玩家上限**
    - 3.1.1.2.1：固定最大玩家數為 9。
    - 3.1.1.2.2：創建變數儲存當前玩家數。
    - 3.1.1.2.3：添加檢查確保不超上限。
    - 3.1.1.2.4：設計可配置選項 (梭哈 2-8 人)。
- **3.1.1.3：初始化獎池**
    - 3.1.1.3.1：創建獎池物件 (主池 + 邊池陣列)。
    - 3.1.1.3.2：設置主池初始值 0。
    - 3.1.1.3.3：設計邊池數據結構 (金額, 資格玩家ID)。
    - 3.1.1.3.4：提供獎池更新接口 (UI)。
- **3.1.1.4：設置遊戲參數**
    - 3.1.1.4.1：定義輪次陣列 (Pre-Flop, Flop, Turn, River, Showdown)。
    - 3.1.1.4.2：設置操作時間 (15秒)。
    - 3.1.1.4.3：創建計時器變數。
    - 3.1.1.4.4：設計參數配置文件。

### 3.1.2：初始化玩家
- **3.1.2.1：創建玩家數據結構**
    - 3.1.2.1.1：定義屬性 (ID, 名稱, 籌碼, 手牌[], 狀態, 座位索引)。
    - 3.1.2.1.2：添加座位索引 (0-8)。
    - 3.1.2.1.3：設計可擴展屬性 (百家樂押注類型)。
- **3.1.2.2：分配玩家座位**
    - 3.1.2.2.1：生成隨機座位順序。
    - 3.1.2.2.2：標記真實玩家。
    - 3.1.2.2.3：標記 AI 占位。
    - 3.1.2.2.4：儲存座位順序。
- **3.1.2.3：初始化玩家籌碼**
    - 3.1.2.3.1：設置起始籌碼 (1000)。
    - 3.1.2.3.2：檢查有效性 (>0)。
    - 3.1.2.3.3：設計籌碼配置文件。
    - 3.1.2.3.4：提供籌碼更新接口 (UI)。
- **3.1.2.4：手機端顯示**
    - 3.1.2.4.1：設計玩家資訊面板。
    - 3.1.2.4.2：確保清晰 (字體>=16px)。
    - 3.1.2.4.3：支援滾動查看 9 人桌。
    - 3.1.2.4.4：點擊座位放大功能。

### 3.1.3：初始化牌堆
- **3.1.3.1：創建撲克牌數據**
    - 3.1.3.1.1：生成 52 張牌陣列 (花色, 點數)。
    - 3.1.3.1.2：分配唯一 ID (S2)。
    - 3.1.3.1.3：添加屬性 (isDealt, position)。
    - 3.1.3.1.4：設計可擴展結構。
- **3.1.3.2：實現洗牌算法**
    - 3.1.3.2.1：Fisher-Yates shuffle。
    - 3.1.3.2.2：添加隨機種子。
    - 3.1.3.2.3：驗證均勻性。
    - 3.1.3.2.4：提供洗牌完成事件。
- **3.1.3.3：設置牌堆狀態**
    - 3.1.3.3.1：記錄剩餘牌數 (52)。
    - 3.1.3.3.2：創建已發牌陣列。
    - 3.1.3.3.3：提供抽牌接口。
    - 3.1.3.3.4：確保可序列化。

### 3.1.4：分配座位與盲注
- **3.1.4.1：確定莊家位置**
    - 3.1.4.1.1：隨機選擇莊家。
    - 3.1.4.1.2：記錄莊家索引。
    - 3.1.4.1.3：設計移動邏輯 (順時針)。
    - 3.1.4.1.4：提供高亮接口 (UI)。
- **3.1.4.2：設置盲注玩家**
    - 3.1.4.2.1：小盲 (莊家+1)。
    - 3.1.4.2.2：大盲 (小盲+1)。
    - 3.1.4.2.3：檢查活躍狀態。
    - 3.1.4.2.4：記錄盲注索引。
- **3.1.4.3：扣除盲注**
    - 3.1.4.3.1：扣小盲金額。
    - 3.1.4.3.2：扣大盲金額。
    - 3.1.4.3.3：加入主池。
    - 3.1.4.3.4：更新籌碼與獎池。
- **3.1.4.4：手機端提示**
    - 3.1.4.4.1：高亮莊家/盲注座位。
    - 3.1.4.4.2：顯示盲注金額。
    - 3.1.4.4.3：確保可見。
    - 3.1.4.4.4：添加籌碼動畫。

### 流程圖 (任務 3.1)

#### 流程圖：創建遊戲配置
```
開始
  ↓
讀取遊戲配置文件
  ↓
設置盲注結構
  ↓ 小盲金額（10）
  ↓ 大盲金額（20）
  ↓ 儲存至配置物件
  ↓ 設置遞增規則（可選）
設置玩家上限
  ↓ 固定9人
  ↓ 記錄當前玩家數（1-9）
  ↓ 驗證不超過上限
初始化獎池
  ↓ 創建主池（0）
  ↓ 創建邊池陣列（空）
  ↓ 提供更新接口
設置遊戲參數
  ↓ 定義輪次陣列（Pre-Flop, Flop, Turn, River, Showdown）
  ↓ 設置操作時間（15秒）
  ↓ 儲存計時器變數
  ↓ 儲存至配置物件
結束
```

#### 流程圖：初始化玩家
```
開始
  ↓
創建玩家數據結構
  ↓ 定義屬性（ID, 名稱, 籌碼, 手牌, 狀態, 座位索引）
分配玩家座位
  ↓ 生成隨機座位順序（1-9）
  ↓ 標記真實玩家
  ↓ 標記AI占位（若不足9人）
  ↓ 儲存座位順序
初始化玩家籌碼
  ↓ 設置起始籌碼（1000）
  ↓ 驗證籌碼有效性（>0）
  ↓ 儲存至玩家物件
  ↓ 提供更新接口
手機端顯示
  ↓ 設計資訊面板（名稱, 籌碼, 座位號）
  ↓ 確保字體清晰（>=16px）
  ↓ 支援滾動查看9人桌
  ↓ 添加點擊放大功能
結束
```

#### 流程圖：初始化牌堆
```
開始
  ↓
創建撲克牌數據
  ↓ 生成52張牌（4花色, 13點數）
  ↓ 分配唯一ID（例如S2）
  ↓ 添加屬性（isDealt, position）
洗牌
  ↓ 執行Fisher-Yates shuffle
  ↓ 使用隨機種子
  ↓ 驗證均勻性
  ↓ 觸發洗牌事件
設置牌堆狀態
  ↓ 記錄剩餘牌數（52）
  ↓ 創建已發牌陣列（空）
  ↓ 提供抽牌接口
  ↓ 確保可序列化
結束
```

#### 流程圖：分配座位與盲注
```
開始
  ↓
確定莊家位置
  ↓ 隨機選擇玩家（索引0-8）
  ↓ 記錄莊家索引
  ↓ 設計移動邏輯（順時針）
  ↓ 提供高亮接口
設置盲注玩家
  ↓ 小盲（莊家+1）
  ↓ 大盲（小盲+1）
  ↓ 檢查玩家活躍
  ↓ 記錄盲注索引
扣除盲注
  ↓ 扣小盲金額
  ↓ 扣大盲金額
  ↓ 加入主池
  ↓ 更新籌碼與獎池
手機端提示
  ↓ 高亮莊家/盲注座位
  ↓ 顯示盲注金額
  ↓ 確保文字可見
  ↓ 添加籌碼動畫
結束
```

---

## 任務 3.2：發牌邏輯
**目標**：實現底牌與公共牌的發放，支援手機端動畫。

### 3.2.1：發放底牌
- **3.2.1.1：分配底牌**
    - 3.2.1.1.1：抽 2 張/玩家。
    - 3.2.1.1.2：順時針發牌 (從小盲)。
    - 3.2.1.1.3：跳過棄牌玩家。
    - 3.2.1.1.4：更新牌堆。
- **3.2.1.2：保護底牌隱私**
    - 3.2.1.2.1：存入玩家物件。
    - 3.2.1.2.2：僅本人可見 (渲染)。
    - 3.2.1.2.3：其他顯示背面。
    - 3.2.1.2.4：支援視角切換。
- **3.2.1.3：記錄手牌**
    - 3.2.1.3.1：存手牌 ID。
    - 3.2.1.3.2：記錄發牌順序 (動畫)。
    - 3.2.1.3.3：提供查詢接口 (比牌)。
    - 3.2.1.3.4：確保可序列化。

### 3.2.2：發放公共牌
- **3.2.2.1：實現燒牌邏輯**
    - 3.2.2.1.1：移除牌堆頂 1 張。
    - 3.2.2.1.2：更新牌堆。
    - 3.2.2.1.3：記錄燒牌 (除錯)。
    - 3.2.2.1.4：確保不影響邏輯。
- **3.2.2.2：發放翻牌 (Flop)**
    - 3.2.2.2.1：燒牌後抽 3 張。
    - 3.2.2.2.2：記錄 ID 與位置 (Three.js)。
    - 3.2.2.2.3：更新牌堆。
    - 3.2.2.2.4：觸發翻牌事件。
- **3.2.2.3：發放轉牌 (Turn)**
    - 3.2.2.3.1：燒牌後抽 1 張。
    - 3.2.2.3.2：記錄 ID 與位置。
    - 3.2.2.3.3：更新牌堆。
    - 3.2.2.3.4：觸發轉牌事件。
- **3.2.2.4：發放河牌 (River)**
    - 3.2.2.4.1：燒牌後抽 1 張。
    - 3.2.2.4.2：記錄 ID 與位置。
    - 3.2.2.4.3：更新牌堆。
    - 3.2.2.4.4：觸發河牌事件。
- **3.2.2.5：手機端顯示**
    - 3.2.2.5.1：公共牌置中縮放。
    - 3.2.2.5.2：點擊放大功能。
    - 3.2.2.5.3：添加翻牌動畫提示。
    - 3.2.2.5.4：避免牌重疊。

### 3.2.3：發牌動畫接口
- **3.2.3.1：提供發牌數據**
    - 3.2.3.1.1：輸出 ID, 起始位置, 目標位置。
    - 3.2.3.1.2：JSON 格式。
    - 3.2.3.1.3：與 Three.js 相容。
- **3.2.3.2：定義動畫參數**
    - 3.2.3.2.1：速度 (0.5s/張)。
    - 3.2.3.2.2：路徑 (直線/曲線)。
    - 3.2.3.2.3：延遲 (0.1s 間隔)。
    - 3.2.3.2.4：配置文件。
- **3.2.3.3：支援手機觸控**
    - 3.2.3.3.1：點擊手牌放大。
    - 3.2.3.3.2：拖動調整視角。
    - 3.2.3.3.3：動畫不影響觸控。
    - 3.2.3.3.4：測試流暢性 (60fps)。

### 流程圖 (任務 3.2)

#### 流程圖：發放底牌
```
開始
  ↓
分配底牌
  ↓ 從牌堆抽2張牌/玩家
  ↓ 按順時針發牌（從小盲）
  ↓ 跳過棄牌玩家
  ↓ 更新牌堆狀態
保護底牌隱私
  ↓ 存入玩家物件
  ↓ 僅本人可見（Three.js）
  ↓ 其他玩家顯示背面
  ↓ 支援視角切換
記錄手牌
  ↓ 存手牌ID至玩家
  ↓ 記錄發牌順序
  ↓ 提供查詢接口
  ↓ 確保可序列化
結束
```

#### 流程圖：發放公共牌
```
開始
  ↓
燒牌
  ↓ 移除牌堆頂部1張
  ↓ 更新牌堆狀態
  ↓ 記錄燒牌
發放翻牌
  ↓ 抽3張牌
  ↓ 記錄ID與位置
  ↓ 更新牌堆
  ↓ 觸發翻牌事件
發放轉牌
  ↓ 燒牌
  ↓ 抽1張牌
  ↓ 記錄ID與位置
  ↓ 更新牌堆
  ↓ 觸發轉牌事件
發放河牌
  ↓ 燒牌
  ↓ 抽1張牌
  ↓ 記錄ID與位置
  ↓ 更新牌堆
  ↓ 觸發河牌事件
手機端顯示
  ↓ 公共牌置中顯示
  ↓ 支援點擊放大
  ↓ 添加翻牌動畫
  ↓ 避免牌重疊
結束
```

#### 流程圖：發牌動畫接口
```
開始
  ↓
提供發牌數據
  ↓ 輸出卡牌ID
  ↓ 輸出起始/目標位置
  ↓ 使用JSON格式
  ↓ 確保相容Three.js
定義動畫參數
  ↓ 設置速度（0.5秒/張）
  ↓ 定義路徑（直線/曲線）
  ↓ 設置延遲（0.1秒間隔）
  ↓ 儲存至配置文件
手機觸控支援
  ↓ 點擊手牌放大
  ↓ 拖動調整視角
  ↓ 確保動畫不卡頓
  ↓ 測試60fps
結束
```

---

## 任務 3.3：下注輪管理
**目標**：實現4輪下注，支援手機觸控操作。

### 3.3.1：設置下注輪結構
- **3.3.1.1：定義輪次**
    - 3.3.1.1.1：輪次陣列 (Pre-Flop, Flop, Turn, River)。
    - 3.3.1.1.2：輪次狀態。
    - 3.3.1.1.3：記錄開始玩家索引。
    - 3.3.1.1.4：查詢接口 (UI)。
- **3.3.1.2：設置起始玩家**
    - 3.3.1.2.1：Pre-Flop: 大盲+1。
    - 3.3.1.2.2：Flop/Turn/River: 小盲。
    - 3.3.1.2.3：跳過棄牌/全下。
    - 3.3.1.2.4：記錄索引。
- **3.3.1.3：記錄輪次狀態**
    - 3.3.1.3.1：當前輪次名稱。
    - 3.3.1.3.2：已下注金額 (每位)。
    - 3.3.1.3.3：剩餘活躍玩家數。
    - 3.3.1.3.4：更新接口 (UI)。

### 3.3.2：實現玩家操作
- **3.3.2.1：定義操作選項**
    - 3.3.2.1.1：跟注 (Call)。
    - 3.3.2.1.2：加注 (Raise)。
    - 3.3.2.1.3：棄牌 (Fold)。
    - 3.3.2.1.4：全下 (All-in)。
    - 3.3.2.1.5：過牌 (Check)。
- **3.3.2.2：手機端操作**
    - 3.3.2.2.1：跟注按鈕 (顯示金額)。
    - 3.3.2.2.2：棄牌按鈕 (紅色)。
    - 3.3.2.2.3：過牌按鈕 (動態)。
    - 3.3.2.2.4：加注滑桿。
    - 3.3.2.2.5：全下按鈕。
- **3.3.2.3：驗證操作**
    - 3.3.2.3.1：檢查籌碼。
    - 3.3.2.3.2：驗證加注額。
    - 3.3.2.3.3：棄牌不影響獎池。
    - 3.3.2.3.4：檢查全下資格。
- **3.3.2.4：記錄操作**
    - 3.3.2.4.1：更新本輪下注額。
    - 3.3.2.4.2：扣除籌碼。
    - 3.3.2.4.3：加入獎池。
    - 3.3.2.4.4：記錄日誌。

### 3.3.3：管理下注邏輯
- **3.3.3.1：追蹤下注狀態**
    - 3.3.3.1.1：記錄玩家本輪下注。
    - 3.3.3.1.2：追蹤當前最高下注。
    - 3.3.3.1.3：記錄已操作玩家數。
    - 3.3.3.1.4：提供狀態接口 (UI)。
- **3.3.3.2：結束下注輪**
    - 3.3.3.2.1：檢查所有活躍玩家。
    - 3.3.3.2.2：若剩 1 人，結束遊戲。
    - 3.3.3.2.3：觸發結束事件。
    - 3.3.3.2.4：重置本輪狀態。
- **3.3.3.3：處理全下**
    - 3.3.3.3.1：記錄全下金額。
    - 3.3.3.3.2：創建邊池。
    - 3.3.3.3.3：繼續下注輪。
    - 3.3.3.3.4：確保邊池數據正確。
- **3.3.3.4：手機端提示**
    - 3.3.3.4.1：顯示當前最高下注。
    - 3.3.3.4.2：顯示獎池金額。
    - 3.3.3.4.3：高亮可操作按鈕。
    - 3.3.3.4.4：適配小螢幕。

### 3.3.4：計時器與提示
- **3.3.4.1：設置計時器**
    - 3.3.4.1.1：15 秒倒計時。
    - 3.3.4.1.2：記錄剩餘時間。
    - 3.3.4.1.3：提供暫停功能。
    - 3.3.4.1.4：配置文件。
- **3.3.4.2：處理超時**
    - 3.3.4.2.1：需跟注 -> 棄牌。
    - 3.3.4.2.2：可過牌 -> 過牌。
    - 3.3.4.2.3：記錄超時事件。
    - 3.3.4.2.4：觸發下位玩家。
- **3.3.4.3：手機端提示**
    - 3.3.4.3.1：進度條。
    - 3.3.4.3.2：高亮當前玩家。
    - 3.3.4.3.3：音效提示。
    - 3.3.4.3.4：不遮擋按鈕。

### 流程圖 (任務 3.3)

#### 流程圖：設置下注輪結構
```
開始
  ↓
定義輪次
  ↓ 創建陣列（Pre-Flop, Flop, Turn, River）
  ↓ 設置輪次狀態
  ↓ 記錄開始玩家
  ↓ 提供查詢接口
設置起始玩家
  ↓ Pre-Flop：大盲+1
  ↓ Flop/Turn/River：小盲
  ↓ 跳過棄牌/全下
  ↓ 記錄索引
記錄輪次狀態
  ↓ 儲存輪次名稱
  ↓ 記錄下注金額
  ↓ 記錄活躍玩家數
  ↓ 提供更新接口
結束
```

#### 流程圖：實現玩家操作
```
開始
  ↓
定義操作選項
  ↓ 跟注（匹配最高下注）
  ↓ 加注（>=大盲2倍）
  ↓ 棄牌（退出）
  ↓ 全下（所有籌碼）
  ↓ 過牌（無需跟注）
手機端操作
  ↓ 跟注按鈕（顯示金額）
  ↓ 棄牌按鈕（紅色）
  ↓ 過牌按鈕（動態顯示）
  ↓ 加注滑桿（範圍限制）
  ↓ 全下按鈕（顯示籌碼）
驗證操作
  ↓ 檢查籌碼（跟注/加注）
  ↓ 驗證加注金額
  ↓ 確保棄牌無影響
  ↓ 檢查全下資格
記錄操作
  ↓ 更新下注金額
  ↓ 扣除籌碼
  ↓ 加入獎池
  ↓ 記錄日誌
結束
```

#### 流程圖：管理下注邏輯
```
開始
  ↓
追蹤下注狀態
  ↓ 記錄玩家下注金額
  ↓ 追蹤最高下注
  ↓ 記錄完成操作數
  ↓ 提供狀態接口
結束下注輪
  ↓ 檢查所有玩家操作
  ↓ 若剩1人，跳至分配
  ↓ 觸發結束事件
  ↓ 重置下注狀態
處理全下
  ↓ 記錄全下金額
  ↓ 創建邊池
  ↓ 繼續下注輪
  ↓ 確保邊池正確
手機端提示
  ↓ 顯示最高下注
  ↓ 顯示獎池金額
  ↓ 高亮操作按鈕
  ↓ 適配小螢幕
結束
```

#### 流程圖：計時器與提示
```
開始
  ↓
設置計時器
  ↓ 創建15秒倒計時
  ↓ 記錄剩餘時間
  ↓ 提供暫停功能
  ↓ 儲存至配置文件
處理超時
  ↓ 若需跟注，棄牌
  ↓ 若可過牌，過牌
  ↓ 記錄超時事件
  ↓ 觸發下位玩家
手機端提示
  ↓ 顯示進度條
  ↓ 高亮當前玩家
  ↓ 添加倒計時音效
  ↓ 確保不遮擋按鈕
結束
```

---

## 任務 3.4：比牌與獎池分配
**目標**：計算牌型，判定贏家並分配獎池。

### 3.4.1：實現牌型計算
- **3.4.1.1：定義牌型**
    - 3.4.1.1.1：10 種牌型 (皇家同花順 -> 高牌)。
    - 3.4.1.1.2：比較規則。
    - 3.4.1.1.3：等級表 (0-9)。
    - 3.4.1.1.4：牌型數據結構。
- **3.4.1.2：計算玩家牌型**
    - 3.4.1.2.1：枚舉 7 選 5 (21 種)。
    - 3.4.1.2.2：檢查牌型等級。
    - 3.4.1.2.3：選最高牌型。
    - 3.4.1.2.4：優化枚舉。
- **3.4.1.3：優化計算**
    - 3.4.1.3.1：預計算公共牌。
    - 3.4.1.3.2：查表法。
    - 3.4.1.3.3：確保 < 100ms。
    - 3.4.1.3.4：除錯接口。

### 3.4.2：判定贏家
- **3.4.2.1：比較牌型**
    - 3.4.2.1.1：按等級排序。
    - 3.4.2.1.2：同級比較關鍵點數。
    - 3.4.2.1.3：再比次高點數。
    - 3.4.2.1.4：記錄贏家 ID。
- **3.4.2.2：處理平局**
    - 3.4.2.2.1：檢查完全相同。
    - 3.4.2.2.2：記錄平局玩家 ID[]。
    - 3.4.2.2.3：計算平分金額。
    - 3.4.2.2.4：提供平局接口 (UI)。
- **3.4.2.3：手機端顯示**
    - 3.4.2.3.1：顯示玩家牌型。
    - 3.4.2.3.2：高亮贏家手牌。
    - 3.4.2.3.3：顯示平局提示。
    - 3.4.2.3.4：適配小螢幕。

### 3.4.3：分配獎池
- **3.4.3.1：計算主池**
    - 3.4.3.1.1：檢查金額。
    - 3.4.3.1.2：分配給贏家/平分。
    - 3.4.3.1.3：更新籌碼。
    - 3.4.3.1.4：清空主池。
- **3.4.3.2：處理邊池 (見 3.4.4)**
- **3.4.3.3：動畫接口**
    - 3.4.3.3.1：輸出分配數據 (贏家ID, 金額)。
    - 3.4.3.3.2：定義籌碼路徑。
    - 3.4.3.3.3：設置速度。
    - 3.4.3.3.4：確保手機流暢。
- **3.4.3.4：手機端提示**
    - 3.4.3.4.1：顯示分配結果。
    - 3.4.3.4.2：顯示邊池分配。
    - 3.4.3.4.3：確保清晰。
    - 3.4.3.4.4：贏牌音效。

### 3.4.4：處理邊池
- **3.4.4.1：記錄全下**
    - 3.4.4.1.1：記錄下注額。
    - 3.4.4.1.2：標記 "all-in"。
    - 3.4.4.1.3：記錄順序。
    - 3.4.4.1.4：提供事件接口 (UI)。
- **3.4.4.2：計算邊池**
    - 3.4.4.2.1：按金額分層。
    - 3.4.4.2.2：記錄資格玩家 ID。
    - 3.4.4.2.3：驗證金額。
    - 3.4.4.2.4：提供數據接口 (比牌)。
- **3.4.4.3：分配邊池**
    - 3.4.4.3.1：按邊池順序比較資格玩家牌型。
    - 3.4.4.3.2：分配給贏家/平分。
    - 3.4.4.3.3：更新籌碼。
    - 3.4.4.3.4：觸發事件 (UI/動畫)。

### 流程圖 (任務 3.4)

#### 流程圖：實現牌型計算
```
開始
  ↓
定義牌型
  ↓ 列出10種牌型
  ↓ 定義比較規則
  ↓ 創建等級表（0-9）
  ↓ 儲存牌型結構
計算玩家牌型
  ↓ 枚舉7選5組合（21種）
  ↓ 檢查每組合牌型
  ↓ 選最高牌型
  ↓ 記錄5張牌
優化計算
  ↓ 預計算公共牌
  ↓ 使用查表法
  ↓ 確保<100ms
  ↓ 提供除錯接口
結束
```

#### 流程圖：判定贏家
```
開始
  ↓
比較牌型
  ↓ 按等級排序
  ↓ 若相同，比較點數
  ↓ 若點數相同，比較次高
  ↓ 記錄贏家ID
處理平局
  ↓ 檢查牌型/點數相同
  ↓ 記錄平局玩家
  ↓ 計算平分金額
  ↓ 提供平局接口
手機端顯示
  ↓ 顯示玩家牌型
  ↓ 高亮贏家手牌
  ↓ 顯示平局提示
  ↓ 適配小螢幕
結束
```

#### 流程圖：分配獎池
```
開始
  ↓
計算主池
  ↓ 檢查主池金額
  ↓ 分配給贏家
  ↓ 更新籌碼
  ↓ 清空主池
處理邊池
  ↓ 按順序處理
  ↓ 檢查資格玩家
  ↓ 分配邊池
  ↓ 更新籌碼
動畫接口
  ↓ 輸出分配數據
  ↓ 定義籌碼路徑
  ↓ 設置動畫速度
  ↓ 確保手機流暢
手機端提示
  ↓ 顯示分配結果
  ↓ 顯示邊池分配
  ↓ 確保文字清晰
  ↓ 添加贏牌音效
結束
```

#### 流程圖：處理邊池
```
開始
  ↓
記錄全下
  ↓ 記錄下注金額
  ↓ 標記全下狀態
  ↓ 記錄全下順序
  ↓ 提供全下事件
計算邊池
  ↓ 按金額分層
  ↓ 記錄資格玩家
  ↓ 驗證金額
  ↓ 提供邊池數據
分配邊池
  ↓ 比較資格玩家牌型
  ↓ 分配邊池
  ↓ 更新籌碼
  ↓ 觸發分配事件
結束
```

---

## 任務 3.5：狀態管理
**目標**：追蹤遊戲與玩家狀態。

### 3.5.1：遊戲狀態
- **3.5.1.1：記錄輪次**
    - 3.5.1.1.1：當前輪次名稱。
    - 3.5.1.1.2：輪次進度。
    - 3.5.1.1.3：查詢接口 (UI)。
    - 3.5.1.1.4：確保可序列化。
- **3.5.1.2：追蹤獎池**
    - 3.5.1.2.1：主池金額。
    - 3.5.1.2.2：邊池數據。
    - 3.5.1.2.3：更新接口 (UI)。
    - 3.5.1.2.4：驗證金額。
- **3.5.1.3：記錄下注**
    - 3.5.1.3.1：最高下注額。
    - 3.5.1.3.2：玩家本輪下注。
    - 3.5.1.3.3：狀態接口 (UI)。
    - 3.5.1.3.4：確保一致性。

### 3.5.2：玩家狀態
- **3.5.2.1：更新狀態**
    - 3.5.2.1.1：棄牌 -> "folded"。
    - 3.5.2.1.2：全下 -> "all-in"。
    - 3.5.2.1.3：更新籌碼。
    - 3.5.2.1.4：記錄手牌。
- **3.5.2.2：手機端顯示**
    - 3.5.2.2.1：即時更新 (座位變灰)。
    - 3.5.2.2.2：籌碼變化。
    - 3.5.2.2.3：點擊查看詳情。
    - 3.5.2.2.4：確保 9 人桌清晰。

### 3.5.3：輪次切換
- **3.5.3.1：檢測輪次結束**
    - 3.5.3.1.1：檢查玩家操作。
    - 3.5.3.1.2：剩 1 人 -> 跳至分配。
    - 3.5.3.1.3：記錄結束時間。
    - 3.5.3.1.4：觸發事件。
- **3.5.3.2：重置狀態**
    - 3.5.3.2.1：清下注記錄。
    - 3.5.3.2.2：重置操作狀態。
    - 3.5.3.2.3：準備下一輪。
    - 3.5.3.2.4：提供接口 (UI)。
- **3.5.3.3：手機端提示**
    - 3.5.3.3.1：顯示輪次文字。
    - 3.5.3.3.2：動畫。
    - 3.5.3.3.3：不遮擋公共牌。
    - 3.5.3.3.4：支援跳過動畫。

### 3.5.4：遊戲結束與重啟
- **3.5.4.1：結束本局**
    - 3.5.4.1.1：標記結束。
    - 3.5.4.1.2：記錄贏家/獎池。
    - 3.5.4.1.3：儲存結果。
    - 3.5.4.1.4：觸發事件 (UI)。
- **3.5.4.2：開始下一局**
    - 3.5.4.2.1：重新洗牌。
    - 3.5.4.2.2：移動莊家。
    - 3.5.4.2.3：重置狀態。
    - 3.5.4.2.4：扣除新盲注。
- **3.5.4.3：手機端提示**
    - 3.5.4.3.1：顯示結果。
    - 3.5.4.3.2：下一局按鈕。
    - 3.5.4.3.3：過渡動畫。
    - 3.5.4.3.4：適配小螢幕。

### 流程圖 (任務 3.5)

#### 流程圖：遊戲狀態
```
開始
  ↓
記錄輪次
  ↓ 儲存輪次名稱
  ↓ 記錄進度
  ↓ 提供查詢接口
  ↓ 確保可序列化
追蹤獎池
  ↓ 記錄主池
  ↓ 記錄邊池
  ↓ 提供更新接口
  ↓ 驗證金額
記錄下注
  ↓ 記錄最高下注
  ↓ 記錄玩家下注
  ↓ 提供狀態接口
  ↓ 確保與獎池同步
結束
```

#### 流程圖：玩家狀態
```
開始
  ↓
更新狀態
  ↓ 棄牌→folded
  ↓ 全下→all-in
  ↓ 更新籌碼
  ↓ 記錄手牌
手機端顯示
  ↓ 即時更新狀態
  ↓ 顯示籌碼變化
  ↓ 支援點擊查看
  ↓ 確保9人桌清晰
結束
```

#### 流程圖：輪次切換
```
開始
  ↓
檢測輪次結束
  ↓ 檢查所有玩家操作
  ↓ 若剩1人，跳至分配
  ↓ 記錄結束時間
  ↓ 觸發結束事件
重置狀態
  ↓ 清除下注記錄
  ↓ 重置操作狀態
  ↓ 準備下一輪
  ↓ 提供重置接口
手機端提示
  ↓ 顯示輪次文字
  ↓ 添加動畫
  ↓ 確保不遮擋
  ↓ 支援跳過動畫
結束
```

#### 流程圖：遊戲結束與重啟
```
開始
  ↓
結束本局
  ↓ 標記結束
  ↓ 記錄贏家
  ↓ 儲存結果
  ↓ 觸發結束事件
開始下一局
  ↓ 重新洗牌
  ↓ 移動莊家
  ↓ 重置狀態
  ↓ 扣除盲注
手機端提示
  ↓ 顯示結果
  ↓ 設計下一局按鈕
  ↓ 添加過渡動畫
  ↓ 適配小螢幕
結束
```

---

## 任務 3.6：手機優先優化
**目標**：確保邏輯適配手機觸控。

### 3.6.1：簡化操作流程
- **3.6.1.1：提供快速操作**
    - 3.6.1.1.1：一鍵跟注。
    - 3.6.1.1.2：一鍵全下。
    - 3.6.1.1.3：預設加注選項。
    - 3.6.1.1.4：優先顯示。
- **3.6.1.2：減少點擊**
    - 3.6.1.2.1：滑動選加注額。
    - 3.6.1.2.2：自動聚焦按鈕。
    - 3.6.1.2.3：快速棄牌手勢。
    - 3.6.1.2.4：測試效率 (<3s/輪)。

### 3.6.2：觸控友好
- **3.6.2.1：設計按鈕**
    - 3.6.2.1.1：尺寸 >= 44x44px。
    - 3.6.2.1.2：間距 >= 10px。
    - 3.6.2.1.3：高對比顏色。
    - 3.6.2.1.4：點擊反饋。
- **3.6.2.2：支援多點觸控**
    - 3.6.2.2.1：雙指縮放。
    - 3.6.2.2.2：單指拖動。
    - 3.6.2.2.3：分離事件處理。
    - 3.6.2.2.4：測試穩定性。

### 3.6.3：視覺提示
- **3.6.3.1：高亮當前玩家**
    - 3.6.3.1.1：閃爍邊框。
    - 3.6.3.1.2：放大座位。
    - 3.6.3.1.3：箭頭指向。
    - 3.6.3.1.4：確保明顯。
- **3.6.3.2：顯示操作提示**
    - 3.6.3.2.1：動態顯示操作。
    - 3.6.3.2.2：無效操作彈窗。
    - 3.6.3.2.3：文字清晰。
    - 3.6.3.2.4：支援關閉。
- **3.6.3.3：倒計時提示**
    - 3.6.3.3.1：進度條。
    - 3.6.3.3.2：數字倒計時。
    - 3.6.3.3.3：最後 5 秒變紅。
    - 3.6.3.3.4：不遮擋按鈕。

### 流程圖 (任務 3.6)

#### 流程圖：簡化操作流程
```
開始
  ↓
提供快速操作
  ↓ 跟注按鈕（顯示金額）
  ↓ 全下按鈕（顯示籌碼）
  ↓ 預設加注（2倍大盲）
  ↓ 優先顯示按鈕
減少點擊
  ↓ 滑動選擇加注
  ↓ 自動聚焦按鈕
  ↓ 快速棄牌手勢
  ↓ 測試操作效率
結束
```

#### 流程圖：觸控友好
```
開始
  ↓
設計按鈕
  ↓ 尺寸>=44x44px
  ↓ 間距>=10px
  ↓ 高對比顏色
  ↓ 點擊反饋動畫
支援多點觸控
  ↓ 雙指縮放
  ↓ 單指拖動
  ↓ 分離事件處理
  ↓ 測試穩定性
結束
```

#### 流程圖：視覺提示
```
開始
  ↓
高亮當前玩家
  ↓ 閃爍邊框
  ↓ 放大座位
  ↓ 添加箭頭
  ↓ 確保明顯
顯示操作提示
  ↓ 動態顯示操作
  ↓ 無效操作彈窗
  ↓ 文字清晰
  ↓ 支援關閉
倒計時提示
  ↓ 圓形進度條
  ↓ 數字倒計時
  ↓ 最後5秒變紅
  ↓ 不遮擋按鈕
結束
```
---

</rewritten_file> 