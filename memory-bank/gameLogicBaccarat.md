# 百家樂 (Baccarat) 遊戲邏輯詳細規劃

本文檔詳細記錄了標準百家樂 (Punto Banco) 遊戲的核心邏輯設計，涵蓋初始化、下注、發牌與補牌、結算、狀態管理和手機優化等方面，並包含各主要環節的流程圖。

**假設**: 使用 8 副牌，包含閒對/莊對邊注，莊家贏抽 5% 佣金。

---

## 任務 5.1：百家樂 - 初始化遊戲
**目標**：設置百家樂遊戲環境，處理多副牌牌靴 (Shoe)，設定下注區域。

### 5.1.1：創建遊戲配置
- **5.1.1.1：定義賠率與佣金**
    - 5.1.1.1.1：設置閒家贏賠率 (1:1)。
    - 5.1.1.1.2：設置莊家贏賠率 (1:1)。
    - 5.1.1.1.3：設置莊家贏佣金比例 (5%)。
    - 5.1.1.1.4：設置和局賠率 (例如 1:8)。
    - 5.1.1.1.5：設置閒對賠率 (例如 1:11)。
    - 5.1.1.1.6：設置莊對賠率 (例如 1:11)。
    - 5.1.1.1.7：創建配置文件儲存賠率和佣金。
- **5.1.1.2：設置下注限額**
    - 5.1.1.2.1：設置主要下注區 (閒/莊/和) 的最小/最大下注額。
    - 5.1.1.2.2：設置邊注區 (閒對/莊對) 的最小/最大下注額。
    - 5.1.1.2.3：儲存至配置文件。
- **5.1.1.3：設置牌靴 (Shoe)**
    - 5.1.1.3.1：定義使用的牌副數 (例如 8 副)。
    - 5.1.1.3.2：記錄牌靴中剩餘牌的大致數量或比例。
    - 5.1.1.3.3：設置切牌標記 (Cutting Card) 位置 (例如倒數 14 張牌時提示換靴)。
    - 5.1.1.3.4：設計換靴 (Reshuffle) 邏輯。

### 5.1.2：初始化玩家 (簡化)
- **5.1.2.1：創建玩家數據結構** (ID, 名稱, 籌碼, 當前下注{})。
- **5.1.2.2：初始化玩家籌碼** (同 Hold'em)。
- **5.1.2.3：手機端顯示** (顯示籌碼、下注區域)。

### 5.1.3：初始化牌堆 (多副牌牌靴)
- **5.1.3.1：創建多副牌數據**
    - 5.1.3.1.1：生成 N * 52 張牌陣列 (N=牌副數)。
    - (其他同 Hold'em 3.1.3.1)。
- **5.1.3.2：實現洗牌算法** (同 Hold'em 3.1.3.2，應用於整個牌靴)。
- **5.1.3.3：設置牌靴狀態**
    - 5.1.3.3.1：記錄牌靴剩餘牌數。
    - 5.1.3.3.2：追蹤已發牌。
    - 5.1.3.3.3：實現抽牌接口。
    - 5.1.3.3.4：處理切牌標記到達事件 (提示換靴)。
- **5.1.3.4：首輪燒牌**
    - 5.1.3.4.1：洗牌後，翻開第一張牌。
    - 5.1.3.4.2：根據第一張牌的點數 (10/J/Q/K=10)，從牌靴頂部燒掉相應數量的牌。

### 流程圖 (任務 5.1)

#### 流程圖：創建遊戲配置
```
開始
  ↓
讀取遊戲配置文件
  ↓
設置賠率與佣金 (閒/莊/和/對子)
  ↓
設置下注限額 (主區/邊注)
  ↓
設置牌靴參數 (牌副數, 切牌標記)
  ↓
儲存至配置物件
結束
```

#### 流程圖：初始化玩家
```
開始
  ↓
創建玩家數據結構 (ID, 名稱, 籌碼, 當前下注{})
  ↓
初始化玩家籌碼
  ↓
手機端顯示 (籌碼, 下注區)
結束
```

#### 流程圖：初始化牌靴
```
開始
  ↓
創建 N 副牌數據
  ↓
洗牌 (整個牌靴)
  ↓
設置牌靴狀態 (剩餘牌數, 切牌位置)
  ↓
執行首輪燒牌 (根據第一張牌點數)
結束
```

---

## 任務 5.2：百家樂 - 下注階段
**目標**：允許玩家在發牌前下注於閒、莊、和、閒對、莊對。

### 5.2.1：開放下注
- **5.2.1.1：設置下注時間** (例如 20 秒)。
- **5.2.1.2：顯示下注區域** (閒 Player, 莊 Banker, 和 Tie, 閒對 Player Pair, 莊對 Banker Pair)。
- **5.2.1.3：啟動下注計時器**。

### 5.2.2：處理玩家下注
- **5.2.2.1：接收下注請求** (玩家ID, 下注區域, 下注金額)。
- **5.2.2.2：驗證下注**
    - 5.2.2.2.1：檢查玩家籌碼是否足夠。
    - 5.2.2.2.2：檢查下注金額是否在區域限額內。
    - 5.2.2.2.3：檢查是否仍在下注時間內。
- **5.2.2.3：記錄玩家下注**
    - 5.2.2.3.1：更新玩家 `當前下注{}` 對象 (例如 `{"player": 100, "banker_pair": 10}`)。
    - 5.2.2.3.2：從玩家籌碼中預扣除下注金額。
    - 5.2.2.3.3：更新 UI 顯示玩家在各區域的下注。
- **5.2.2.4：手機端操作**
    - 5.2.2.4.1：點擊下注區域。
    - 5.2.2.4.2：選擇籌碼面額。
    - 5.2.2.4.3：提供 "重複上局下注" 按鈕。
    - 5.2.2.4.4：提供 "清除下注" 按鈕。

### 5.2.3：結束下注
- **5.2.3.1：計時器歸零或荷官觸發**。
- **5.2.3.2：停止接受新的下注**。
- **5.2.3.3：確認所有玩家的最終下注**。
- **5.2.3.4：觸發發牌階段事件**。

### 流程圖 (任務 5.2)

#### 流程圖：下注流程
```
開始
  ↓
顯示下注區域
  ↓
啟動下注計時器 (20s)
  ↓
循環 (直到時間結束):
  ↓   接收玩家下注請求
  ↓   驗證下注 (籌碼, 限額, 時間)
  ↓   IF 驗證通過:
  ↓     記錄下注
  ↓     預扣籌碼
  ↓     更新 UI
  ↓   ELSE:
  ↓     提示錯誤
  ↓
時間結束 / 停止下注
  ↓
確認最終下注
  ↓
觸發發牌事件
結束
```

---

## 任務 5.3：百家樂 - 發牌與補牌邏輯
**目標**：按照百家樂規則發放閒家和莊家牌，並根據規則補牌。

### 5.3.1：初始發牌
- **5.3.1.1：發放閒家前兩張牌** (牌 1, 3)。
- **5.3.1.2：發放莊家前兩張牌** (牌 2, 4)。
- **5.3.1.3：記錄與顯示牌面** (記錄閒/莊手牌 ID 和點數, 更新牌靴, UI 顯示)。
- **5.3.1.4：檢查天牌 (Natural)** (若任一方 8/9 點，直接結算)。

### 5.3.2：閒家補牌規則 (Player's Rule)
- **5.3.2.1：檢查閒家點數 (若非天牌)**
    - IF 閒家點數 0-5 -> 閒家補牌。
    - IF 閒家點數 6-7 -> 閒家停牌。
- **5.3.2.2：執行補牌 (若需要)** (抽牌, 更新手牌/點數/牌靴, 記錄補牌動作)。

### 5.3.3：莊家補牌規則 (Banker's Rule)
- **5.3.3.1：檢查莊家是否需要補牌 (基於莊家點數和閒家補牌情況)**
    - IF 閒家停牌:
        - 莊家 0-5 -> 補牌。
        - 莊家 6-7 -> 停牌。
    - IF 閒家補牌:
        - 根據固定表格 (莊家點數 vs 閒家第三張牌) 決定莊家是否補牌。
- **5.3.3.2：執行補牌 (若需要)** (抽牌, 更新手牌/點數/牌靴)。

### 5.3.4：發牌動畫接口
- **5.3.4.1：提供發牌數據** (P1, B1, P2, B2, P3?, B3?)。
- **5.3.4.2：定義動畫參數**。
- **5.3.4.3：手機端顯示** (清晰動畫)。

### 流程圖 (任務 5.3)

#### 流程圖：發牌與補牌
```
開始
  ↓
發初始四張牌 (P1, B1, P2, B2)
  ↓
計算閒/莊初始點數
  ↓
檢查天牌 (Natural 8/9)?
  ↓ YES: 跳至結算
  ↓ NO:
    ↓ 閒家補牌規則 (0-5 補, 6-7 停)
    ↓ IF 閒家補牌: 執行閒家補牌
    ↓
    ↓ 莊家補牌規則
    ↓   IF 閒家停牌: 莊家 0-5 補, 6-7 停
    ↓   IF 閒家補牌: 根據表格決定莊家補牌
    ↓   IF 莊家需補牌: 執行莊家補牌
    ↓
跳至結算
結束
```

---

## 任務 5.4：百家樂 - 結果判定與結算
**目標**：比較閒莊最終點數，判定輸贏和局，計算玩家派彩。

### 5.4.1：判定輸贏和局
- **5.4.1.1：比較最終點數** (閒 vs 莊)。
- **5.4.1.2：記錄結果** (Win: Player/Banker, Tie)。

### 5.4.2：判定邊注 (對子)
- **5.4.2.1：檢查閒對 (Player Pair)** (基於閒家前兩張牌)。
- **5.4.2.2：檢查莊對 (Banker Pair)** (基於莊家前兩張牌)。

### 5.4.3：計算與分配派彩
- **5.4.3.1：遍歷玩家下注**。
- **5.4.3.2：結算閒/莊/和下注** (根據結果和賠率, 莊贏扣佣金)。
- **5.4.3.3：結算對子邊注** (根據對子結果和賠率)。
- **5.4.3.4：更新玩家籌碼**。
- **5.4.3.5：動畫接口** (籌碼移動)。
- **5.4.3.6：手機端提示** (顯示結果和輸贏)。

### 流程圖 (任務 5.4)

#### 流程圖：結果判定與結算
```
開始
  ↓
比較閒/莊最終點數
  ↓ 判定閒贏 / 莊贏 / 和局
  ↓
檢查閒對 (基於閒家前兩張)
  ↓
檢查莊對 (基於莊家前兩張)
  ↓
遍歷玩家下注:
  ↓   結算閒/莊/和 (根據輸贏結果, 莊贏扣佣金)
  ↓   結算閒對/莊對 (根據對子結果)
  ↓   計算總派彩/損失
  ↓   更新玩家籌碼
  ↓
觸發派彩動畫/提示
結束
```

---

## 任務 5.5：百家樂 - 狀態管理
**目標**：追蹤百家樂的遊戲狀態，如牌靴、下注、結果。

### 5.5.1：遊戲狀態
- **5.5.1.1：記錄牌靴狀態** (剩餘牌數, 切牌標記狀態)。
- **5.5.1.2：記錄下注階段狀態** (開放下注/停止下注)。
- **5.5.1.3：記錄當局結果** (閒家牌/點數, 莊家牌/點數, 贏家, 對子結果)。
- **5.5.1.4：記錄歷史路單 (Roadmap)** (可選)。

### 5.5.2：玩家狀態
- **5.5.2.1：記錄當前下注** (各區域下注額)。
- **5.5.2.2：更新籌碼**。

### 5.5.3：局次切換
- **5.5.3.1：檢測本局結束** (派彩完成)。
- **5.5.3.2：檢查是否需要換靴** (到達切牌標記)。
    - 若需要 -> 執行換靴邏輯 (洗牌, 燒牌)。
- **5.5.3.3：重置狀態** (清除上局牌面, 準備下一輪下注)。
- **5.5.3.4：觸發新一局開始事件** (開放下注)。

### 5.5.4：遊戲結束與重啟 (通常指玩家離開桌子或關閉遊戲)。

### 流程圖 (任務 5.5)

#### 流程圖：狀態管理與局次切換
```
開始 (一局結束)
  ↓
記錄本局結果 (用於路單等)
  ↓
檢查是否到達切牌標記?
  ↓ YES: 執行換靴流程 (洗牌, 燒牌, 重置牌靴狀態)
  ↓ NO:
    ↓ (繼續使用當前牌靴)
  ↓
重置當局狀態 (牌面, 下注額)
  ↓
觸發新一局事件 (回到任務 5.2 開放下注)
結束 (等待新一局)
```

---

## 任務 5.6：百家樂 - 手機優先優化
**目標**：確保百家樂界面和下注操作在手機上簡單直觀。

### 5.6.1：簡化操作流程
- **5.6.1.1：清晰的下注區域** (足夠大，易於點擊)。
- **5.6.1.2：便捷的籌碼選擇** (常用面額優先顯示)。
- **5.6.1.3：一鍵重複/清除** ("Repeat Bet", "Clear Bets")。

### 5.6.2：觸控友好
- **5.6.2.1：設計按鈕/區域** (同 Hold'em)。
- **5.6.2.2：牌面顯示** (閒莊牌面清晰分開顯示)。

### 5.6.3：視覺提示
- **5.6.3.1：下注確認** (籌碼堆疊在下注區的視覺效果)。
- **5.6.3.2：開牌動畫** (模擬翻牌效果)。
- **5.6.3.3：結果高亮** (高亮獲勝區域，顯示輸贏金額)。
- **5.6.3.4：倒計時提示** (下注時間)。
- **5.6.3.5：路單顯示** (可選，提供清晰的路單圖表供玩家參考)。

### 流程圖 (任務 5.6)

#### 流程圖：手機優化考量
```
設計階段:
  ↓
下注區域設計 (大, 清晰)
  ↓
籌碼選擇設計 (便捷)
  ↓
快捷按鈕設計 (重複/清除)
  ↓
牌面顯示設計 (手機端清晰)
  ↓
動畫效果設計 (翻牌, 派彩)
  ↓
視覺提示設計 (高亮, 倒計時)
  ↓
路單顯示設計 (可選, 清晰)
開發與測試階段:
  ↓
實現觸控友好的交互
  ↓
測試不同手機屏幕兼容性
  ↓
測試性能與流暢度
結束
```

--- 